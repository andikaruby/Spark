-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE TEMP VIEW df AS
SELECT * FROM (VALUES ('a', 'b'), ('a', 'c'), ('b', 'c'), ('b', 'd'), (NULL, NULL)) AS t(a, b)
-- !query analysis
CreateViewCommand `df`, SELECT * FROM (VALUES ('a', 'b'), ('a', 'c'), ('b', 'c'), ('b', 'd'), (NULL, NULL)) AS t(a, b), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x, b#x]
      +- SubqueryAlias t
         +- Project [col1#x AS a#x, col2#x AS b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
CREATE TEMP VIEW df2 AS
SELECT * FROM (VALUES (1, true), (2, false), (3, false)) AS t(a, b)
-- !query analysis
CreateViewCommand `df2`, SELECT * FROM (VALUES (1, true), (2, false), (3, false)) AS t(a, b), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x, b#x]
      +- SubqueryAlias t
         +- Project [col1#x AS a#x, col2#x AS b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(b) FROM df GROUP BY a
-- !query analysis
Aggregate [a#x], [listagg(b#x, null, 0, 0) AS listagg(b, NULL)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT string_agg(b) FROM df GROUP BY a
-- !query analysis
Aggregate [a#x], [string_agg(b#x, null, 0, 0) AS string_agg(b, NULL)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(b, NULL) FROM df GROUP BY a
-- !query analysis
Aggregate [a#x], [listagg(b#x, null, 0, 0) AS listagg(b, NULL)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(b) FROM df WHERE 1 != 1
-- !query analysis
Aggregate [listagg(b#x, null, 0, 0) AS listagg(b, NULL)#x]
+- Filter NOT (1 = 1)
   +- SubqueryAlias df
      +- View (`df`, [a#x, b#x])
         +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
            +- Project [a#x, b#x]
               +- SubqueryAlias t
                  +- Project [col1#x AS a#x, col2#x AS b#x]
                     +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(b, '|') FROM df GROUP BY a
-- !query analysis
Aggregate [a#x], [listagg(b#x, |, 0, 0) AS listagg(b, |)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, 0, 0) AS listagg(a, NULL)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(DISTINCT a) FROM df
-- !query analysis
Aggregate [listagg(distinct a#x, null, 0, 0) AS listagg(DISTINCT a, NULL)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY a) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, a#x ASC NULLS FIRST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY a ASC NULLS FIRST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY a DESC) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, a#x DESC NULLS LAST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY a DESC NULLS LAST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY a DESC) OVER (PARTITION BY b) FROM df
-- !query analysis
Project [listagg(a, NULL) WITHIN GROUP (ORDER BY a DESC NULLS LAST) OVER (PARTITION BY b ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x]
+- Project [a#x, b#x, listagg(a, NULL) WITHIN GROUP (ORDER BY a DESC NULLS LAST) OVER (PARTITION BY b ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x, listagg(a, NULL) WITHIN GROUP (ORDER BY a DESC NULLS LAST) OVER (PARTITION BY b ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x]
   +- Window [listagg(a#x, null, a#x DESC NULLS LAST, 0, 0) windowspecdefinition(b#x, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS listagg(a, NULL) WITHIN GROUP (ORDER BY a DESC NULLS LAST) OVER (PARTITION BY b ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x], [b#x]
      +- Project [a#x, b#x]
         +- SubqueryAlias df
            +- View (`df`, [a#x, b#x])
               +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
                  +- Project [a#x, b#x]
                     +- SubqueryAlias t
                        +- Project [col1#x AS a#x, col2#x AS b#x]
                           +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY b) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, b#x ASC NULLS FIRST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY b ASC NULLS FIRST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY b DESC) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, b#x DESC NULLS LAST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY b DESC NULLS LAST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a, '|') WITHIN GROUP (ORDER BY b DESC) FROM df
-- !query analysis
Aggregate [listagg(a#x, |, b#x DESC NULLS LAST, 0, 0) AS listagg(a, |) WITHIN GROUP (ORDER BY b DESC NULLS LAST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY b DESC, a ASC) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, b#x DESC NULLS LAST, a#x ASC NULLS FIRST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY b DESC NULLS LAST, a ASC NULLS FIRST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY b DESC, a DESC) FROM df
-- !query analysis
Aggregate [listagg(a#x, null, b#x DESC NULLS LAST, a#x DESC NULLS LAST, 0, 0) AS listagg(a, NULL) WITHIN GROUP (ORDER BY b DESC NULLS LAST, a DESC NULLS LAST)#x]
+- SubqueryAlias df
   +- View (`df`, [a#x, b#x])
      +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(c1) FROM (VALUES (X'DEAD'), (X'BEEF')) AS t(c1)
-- !query analysis
Aggregate [listagg(c1#x, null, 0, 0) AS listagg(c1, NULL)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(c1, NULL) FROM (VALUES (X'DEAD'), (X'BEEF')) AS t(c1)
-- !query analysis
Aggregate [listagg(c1#x, null, 0, 0) AS listagg(c1, NULL)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(c1, X'42') FROM (VALUES (X'DEAD'), (X'BEEF')) AS t(c1)
-- !query analysis
Aggregate [listagg(c1#x, 0x42, 0, 0) AS listagg(c1, X'42')#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(a), listagg(b, ',') FROM df2
-- !query analysis
Aggregate [listagg(cast(a#x as string), null, 0, 0) AS listagg(a, NULL)#x, listagg(cast(b#x as string), ,, 0, 0) AS listagg(b, ,)#x]
+- SubqueryAlias df2
   +- View (`df2`, [a#x, b#x])
      +- Project [cast(a#x as int) AS a#x, cast(b#x as boolean) AS b#x]
         +- Project [a#x, b#x]
            +- SubqueryAlias t
               +- Project [col1#x AS a#x, col2#x AS b#x]
                  +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(c1) FROM (VALUES (ARRAY['a', 'b'])) AS t(c1)
-- !query analysis
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "PARSE_SYNTAX_ERROR",
  "sqlState" : "42601",
  "messageParameters" : {
    "error" : "','",
    "hint" : ""
  }
}


-- !query
SELECT listagg(c1, ', ') FROM (VALUES (X'DEAD'), (X'BEEF')) AS t(c1)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.DATA_DIFF_TYPES",
  "sqlState" : "42K09",
  "messageParameters" : {
    "dataType" : "(\"BINARY\" or \"STRING\")",
    "functionName" : "`listagg`",
    "sqlExpr" : "\"listagg(c1, , )\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 24,
    "fragment" : "listagg(c1, ', ')"
  } ]
}


-- !query
SELECT listagg(b, a) FROM df GROUP BY a
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.NON_FOLDABLE_INPUT",
  "sqlState" : "42K09",
  "messageParameters" : {
    "inputExpr" : "\"a\"",
    "inputName" : "`delimiter`",
    "inputType" : "\"STRING\"",
    "sqlExpr" : "\"listagg(b, a)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 20,
    "fragment" : "listagg(b, a)"
  } ]
}


-- !query
SELECT listagg(a) OVER (ORDER BY a) FROM df
-- !query analysis
Project [listagg(a, NULL) OVER (ORDER BY a ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)#x]
+- Project [a#x, listagg(a, NULL) OVER (ORDER BY a ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)#x, listagg(a, NULL) OVER (ORDER BY a ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)#x]
   +- Window [listagg(a#x, null, 0, 0) windowspecdefinition(a#x ASC NULLS FIRST, specifiedwindowframe(RangeFrame, unboundedpreceding$(), currentrow$())) AS listagg(a, NULL) OVER (ORDER BY a ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)#x], [a#x ASC NULLS FIRST]
      +- Project [a#x]
         +- SubqueryAlias df
            +- View (`df`, [a#x, b#x])
               +- Project [cast(a#x as string) AS a#x, cast(b#x as string) AS b#x]
                  +- Project [a#x, b#x]
                     +- SubqueryAlias t
                        +- Project [col1#x AS a#x, col2#x AS b#x]
                           +- LocalRelation [col1#x, col2#x]


-- !query
SELECT listagg(a) WITHIN GROUP (ORDER BY a) OVER (ORDER BY a) FROM df
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WINDOW_SPEC_FOR_AGGREGATION_FUNC",
  "sqlState" : "42601",
  "messageParameters" : {
    "aggFunc" : "\"listagg(a, NULL, a)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 61,
    "fragment" : "listagg(a) WITHIN GROUP (ORDER BY a) OVER (ORDER BY a)"
  } ]
}


-- !query
SELECT string_agg(a) WITHIN GROUP (ORDER BY a) OVER (ORDER BY a) FROM df
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WINDOW_SPEC_FOR_AGGREGATION_FUNC",
  "sqlState" : "42601",
  "messageParameters" : {
    "aggFunc" : "\"listagg(a, NULL, a)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 64,
    "fragment" : "string_agg(a) WITHIN GROUP (ORDER BY a) OVER (ORDER BY a)"
  } ]
}


-- !query
SELECT listagg(DISTINCT a) OVER (ORDER BY a) FROM df
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DISTINCT_WINDOW_FUNCTION_UNSUPPORTED",
  "sqlState" : "0A000",
  "messageParameters" : {
    "windowExpr" : "\"listagg(DISTINCT a, NULL) OVER (ORDER BY a ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 44,
    "fragment" : "listagg(DISTINCT a) OVER (ORDER BY a)"
  } ]
}


-- !query
SELECT listagg(DISTINCT a) WITHIN GROUP (ORDER BY b) FROM df
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "FUNCTION_AND_ORDER_EXPRESSION_MISMATCH",
  "sqlState" : "42822",
  "messageParameters" : {
    "functionArgs" : "\"a\"",
    "functionName" : "`listagg`",
    "orderExpr" : "\"b\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 52,
    "fragment" : "listagg(DISTINCT a) WITHIN GROUP (ORDER BY b)"
  } ]
}


-- !query
SELECT listagg(DISTINCT a) WITHIN GROUP (ORDER BY a, b) FROM df
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "FUNCTION_AND_ORDER_EXPRESSION_MISMATCH",
  "sqlState" : "42822",
  "messageParameters" : {
    "functionArgs" : "\"a\"",
    "functionName" : "`listagg`",
    "orderExpr" : "\"a\", \"b\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 55,
    "fragment" : "listagg(DISTINCT a) WITHIN GROUP (ORDER BY a, b)"
  } ]
}


-- !query
SELECT listagg(c1) WITHIN GROUP (ORDER BY c1 COLLATE utf8_binary) FROM (VALUES ('a'), ('A'), ('b'), ('B')) AS t(c1)
-- !query analysis
Aggregate [listagg(c1#x, null, collate(c1#x, utf8_binary) ASC NULLS FIRST, 0, 0) AS listagg(c1, NULL) WITHIN GROUP (ORDER BY collate(c1, utf8_binary) ASC NULLS FIRST)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(c1) WITHIN GROUP (ORDER BY c1 COLLATE utf8_lcase) FROM (VALUES ('a'), ('A'), ('b'), ('B')) AS t(c1)
-- !query analysis
Aggregate [listagg(c1#x, null, collate(c1#x, utf8_lcase) ASC NULLS FIRST, 0, 0) AS listagg(c1, NULL) WITHIN GROUP (ORDER BY collate(c1, utf8_lcase) ASC NULLS FIRST)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(DISTINCT c1 COLLATE utf8_binary) FROM (VALUES ('a'), ('A'), ('b'), ('B')) AS t(c1)
-- !query analysis
Aggregate [listagg(distinct collate(c1#x, utf8_binary), null, 0, 0) AS listagg(DISTINCT collate(c1, utf8_binary), NULL)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(DISTINCT c1 COLLATE utf8_lcase) FROM (VALUES ('a'), ('A'), ('b'), ('B')) AS t(c1)
-- !query analysis
Aggregate [listagg(distinct collate(c1#x, utf8_lcase), null, 0, 0) AS listagg(DISTINCT collate(c1, utf8_lcase), NULL)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(DISTINCT c1 COLLATE utf8_lcase) WITHIN GROUP (ORDER BY c1 COLLATE utf8_lcase) FROM (VALUES ('a'), ('B'), ('b'), ('A')) AS t(c1)
-- !query analysis
Aggregate [listagg(distinct collate(c1#x, utf8_lcase), null, collate(c1#x, utf8_lcase) ASC NULLS FIRST, 0, 0) AS listagg(DISTINCT collate(c1, utf8_lcase), NULL) WITHIN GROUP (ORDER BY collate(c1, utf8_lcase) ASC NULLS FIRST)#x]
+- SubqueryAlias t
   +- Project [col1#x AS c1#x]
      +- LocalRelation [col1#x]


-- !query
SELECT listagg(DISTINCT c1 COLLATE utf8_lcase) WITHIN GROUP (ORDER BY c1 COLLATE utf8_binary) FROM (VALUES ('a'), ('b'), ('A'), ('B')) AS t(c1)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "FUNCTION_AND_ORDER_EXPRESSION_MISMATCH",
  "sqlState" : "42822",
  "messageParameters" : {
    "functionArgs" : "\"collate(c1, utf8_lcase)\"",
    "functionName" : "`listagg`",
    "orderExpr" : "\"collate(c1, utf8_binary)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 93,
    "fragment" : "listagg(DISTINCT c1 COLLATE utf8_lcase) WITHIN GROUP (ORDER BY c1 COLLATE utf8_binary)"
  } ]
}
