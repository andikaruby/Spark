-- Automatically generated by SQLQueryTestSuite
-- !query
drop table if exists t
-- !query analysis
DropTable true, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.t


-- !query
create table t(x int, y string) using csv
-- !query analysis
CreateDataSourceTableCommand `spark_catalog`.`default`.`t`, false


-- !query
insert into t values (0, 'abc'), (1, 'def')
-- !query analysis
InsertIntoHadoopFsRelationCommand file:[not included in comparison]/{warehouse_dir}/t, false, CSV, [path=file:[not included in comparison]/{warehouse_dir}/t], Append, `spark_catalog`.`default`.`t`, org.apache.spark.sql.execution.datasources.InMemoryFileIndex(file:[not included in comparison]/{warehouse_dir}/t), [x, y]
+- Project [cast(col1#x as int) AS x#x, cast(col2#x as string) AS y#x]
   +- LocalRelation [col1#x, col2#x]


-- !query
drop table if exists other
-- !query analysis
DropTable true, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.other


-- !query
create table other(a int, b int) using json
-- !query analysis
CreateDataSourceTableCommand `spark_catalog`.`default`.`other`, false


-- !query
insert into other values (1, 1), (1, 2), (2, 4)
-- !query analysis
InsertIntoHadoopFsRelationCommand file:[not included in comparison]/{warehouse_dir}/other, false, JSON, [path=file:[not included in comparison]/{warehouse_dir}/other], Append, `spark_catalog`.`default`.`other`, org.apache.spark.sql.execution.datasources.InMemoryFileIndex(file:[not included in comparison]/{warehouse_dir}/other), [a, b]
+- Project [cast(col1#x as int) AS a#x, cast(col2#x as int) AS b#x]
   +- LocalRelation [col1#x, col2#x]


-- !query
drop table if exists st
-- !query analysis
DropTable true, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.st


-- !query
create table st(x int, col struct<i1:int, i2:int>) using parquet
-- !query analysis
CreateDataSourceTableCommand `spark_catalog`.`default`.`st`, false


-- !query
insert into st values (1, (2, 3))
-- !query analysis
InsertIntoHadoopFsRelationCommand file:[not included in comparison]/{warehouse_dir}/st, false, Parquet, [path=file:[not included in comparison]/{warehouse_dir}/st], Append, `spark_catalog`.`default`.`st`, org.apache.spark.sql.execution.datasources.InMemoryFileIndex(file:[not included in comparison]/{warehouse_dir}/st), [x, col]
+- Project [cast(col1#x as int) AS x#x, named_struct(i1, cast(col2#x.col1 as int), i2, cast(col2#x.col2 as int)) AS col#x]
   +- LocalRelation [col1#x, col2#x]


-- !query
create temporary view join_test_t1 as select * from values (1) as grouping(a)
-- !query analysis
CreateViewCommand `join_test_t1`, select * from values (1) as grouping(a), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x]
      +- SubqueryAlias grouping
         +- LocalRelation [a#x]


-- !query
create temporary view join_test_t2 as select * from values (1) as grouping(a)
-- !query analysis
CreateViewCommand `join_test_t2`, select * from values (1) as grouping(a), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x]
      +- SubqueryAlias grouping
         +- LocalRelation [a#x]


-- !query
create temporary view join_test_t3 as select * from values (1) as grouping(a)
-- !query analysis
CreateViewCommand `join_test_t3`, select * from values (1) as grouping(a), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x]
      +- SubqueryAlias grouping
         +- LocalRelation [a#x]


-- !query
create temporary view join_test_empty_table as select a from join_test_t2 where false
-- !query analysis
CreateViewCommand `join_test_empty_table`, select a from join_test_t2 where false, false, false, LocalTempView, UNSUPPORTED, true
   +- Project [a#x]
      +- Filter false
         +- SubqueryAlias join_test_t2
            +- View (`join_test_t2`, [a#x])
               +- Project [cast(a#x as int) AS a#x]
                  +- Project [a#x]
                     +- SubqueryAlias grouping
                        +- LocalRelation [a#x]


-- !query
create temporary view lateral_test_t1(c1, c2)
  as values (0, 1), (1, 2)
-- !query analysis
CreateViewCommand `lateral_test_t1`, [(c1,None), (c2,None)], values (0, 1), (1, 2), false, false, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x]


-- !query
create temporary view lateral_test_t2(c1, c2)
  as values (0, 2), (0, 3)
-- !query analysis
CreateViewCommand `lateral_test_t2`, [(c1,None), (c2,None)], values (0, 2), (0, 3), false, false, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x]


-- !query
create temporary view lateral_test_t3(c1, c2)
  as values (0, array(0, 1)), (1, array(2)), (2, array()), (null, array(4))
-- !query analysis
CreateViewCommand `lateral_test_t3`, [(c1,None), (c2,None)], values (0, array(0, 1)), (1, array(2)), (2, array()), (null, array(4)), false, false, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x]


-- !query
create temporary view lateral_test_t4(c1, c2)
  as values (0, 1), (0, 2), (1, 1), (1, 3)
-- !query analysis
CreateViewCommand `lateral_test_t4`, [(c1,None), (c2,None)], values (0, 1), (0, 2), (1, 1), (1, 3), false, false, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x]


-- !query
create temporary view natural_join_test_t1 as select * from values
  ("one", 1), ("two", 2), ("three", 3) as natural_join_test_t1(k, v1)
-- !query analysis
CreateViewCommand `natural_join_test_t1`, select * from values
  ("one", 1), ("two", 2), ("three", 3) as natural_join_test_t1(k, v1), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [k#x, v1#x]
      +- SubqueryAlias natural_join_test_t1
         +- LocalRelation [k#x, v1#x]


-- !query
create temporary view natural_join_test_t2 as select * from values
  ("one", 1), ("two", 22), ("one", 5) as natural_join_test_t2(k, v2)
-- !query analysis
CreateViewCommand `natural_join_test_t2`, select * from values
  ("one", 1), ("two", 22), ("one", 5) as natural_join_test_t2(k, v2), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [k#x, v2#x]
      +- SubqueryAlias natural_join_test_t2
         +- LocalRelation [k#x, v2#x]


-- !query
create temporary view natural_join_test_t3 as select * from values
  ("one", 4), ("two", 5), ("one", 6) as natural_join_test_t3(k, v3)
-- !query analysis
CreateViewCommand `natural_join_test_t3`, select * from values
  ("one", 4), ("two", 5), ("one", 6) as natural_join_test_t3(k, v3), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [k#x, v3#x]
      +- SubqueryAlias natural_join_test_t3
         +- LocalRelation [k#x, v3#x]


-- !query
table t
|> select 1 as x
-- !query analysis
Project [pipeselect(1) AS x#x]
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select x, y
-- !query analysis
Project [x#x, y#x]
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select x, y
|> select x + length(y) as z
-- !query analysis
Project [pipeselect((x#x + length(y#x))) AS z#x]
+- Project [x#x, y#x]
   +- SubqueryAlias spark_catalog.default.t
      +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
values (0), (1) tab(col)
|> select col * 2 as result
-- !query analysis
Project [pipeselect((col#x * 2)) AS result#x]
+- SubqueryAlias tab
   +- LocalRelation [col#x]


-- !query
(select * from t union all select * from t)
|> select x + length(y) as result
-- !query analysis
Project [pipeselect((x#x + length(y#x))) AS result#x]
+- Union false, false
   :- Project [x#x, y#x]
   :  +- SubqueryAlias spark_catalog.default.t
   :     +- Relation spark_catalog.default.t[x#x,y#x] csv
   +- Project [x#x, y#x]
      +- SubqueryAlias spark_catalog.default.t
         +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
(table t
 |> select x, y
 |> select x)
union all
select x from t where x < 1
-- !query analysis
Union false, false
:- Project [x#x]
:  +- Project [x#x, y#x]
:     +- SubqueryAlias spark_catalog.default.t
:        +- Relation spark_catalog.default.t[x#x,y#x] csv
+- Project [x#x]
   +- Filter (x#x < 1)
      +- SubqueryAlias spark_catalog.default.t
         +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
(select col from st)
|> select col.i1
-- !query analysis
Project [col#x.i1 AS i1#x]
+- Project [col#x]
   +- SubqueryAlias spark_catalog.default.st
      +- Relation spark_catalog.default.st[x#x,col#x] parquet


-- !query
table st
|> select st.col.i1
-- !query analysis
Project [col#x.i1 AS i1#x]
+- SubqueryAlias spark_catalog.default.st
   +- Relation spark_catalog.default.st[x#x,col#x] parquet


-- !query
table t
|> select (select a from other where x = a limit 1) as result
-- !query analysis
Project [pipeselect(scalar-subquery#x [x#x]) AS result#x]
:  +- GlobalLimit 1
:     +- LocalLimit 1
:        +- Project [a#x]
:           +- Filter (outer(x#x) = a#x)
:              +- SubqueryAlias spark_catalog.default.other
:                 +- Relation spark_catalog.default.other[a#x,b#x] json
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
select (values (0) tab(col) |> select col) as result
-- !query analysis
Project [scalar-subquery#x [] AS result#x]
:  +- Project [col#x]
:     +- SubqueryAlias tab
:        +- LocalRelation [col#x]
+- OneRowRelation


-- !query
table t
|> select (select any_value(a) from other where x = a limit 1) as result
-- !query analysis
Project [pipeselect(scalar-subquery#x [x#x]) AS result#x]
:  +- GlobalLimit 1
:     +- LocalLimit 1
:        +- Aggregate [any_value(a#x, false) AS any_value(a)#x]
:           +- Filter (outer(x#x) = a#x)
:              +- SubqueryAlias spark_catalog.default.other
:                 +- Relation spark_catalog.default.other[a#x,b#x] json
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select x + length(x) as z, z + 1 as plus_one
-- !query analysis
Project [z#x, pipeselect((z#x + 1)) AS plus_one#x]
+- Project [x#x, y#x, pipeselect((x#x + length(cast(x#x as string)))) AS z#x]
   +- SubqueryAlias spark_catalog.default.t
      +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select first_value(x) over (partition by y) as result
-- !query analysis
Project [result#x]
+- Project [x#x, y#x, _we0#x, pipeselect(_we0#x) AS result#x]
   +- Window [first_value(x#x, false) windowspecdefinition(y#x, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#x], [y#x]
      +- Project [x#x, y#x]
         +- SubqueryAlias spark_catalog.default.t
            +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
select 1 x, 2 y, 3 z
|> select 1 + sum(x) over (),
     avg(y) over (),
     x,
     avg(x+1) over (partition by y order by z) AS a2
|> select a2
-- !query analysis
Project [a2#x]
+- Project [(1 + sum(x) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))#xL, avg(y) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x, x#x, a2#x]
   +- Project [x#x, y#x, _w1#x, z#x, _we0#xL, avg(y) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x, _we2#x, (cast(1 as bigint) + _we0#xL) AS (1 + sum(x) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))#xL, avg(y) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x, pipeselect(_we2#x) AS a2#x]
      +- Window [avg(_w1#x) windowspecdefinition(y#x, z#x ASC NULLS FIRST, specifiedwindowframe(RangeFrame, unboundedpreceding$(), currentrow$())) AS _we2#x], [y#x], [z#x ASC NULLS FIRST]
         +- Window [sum(x#x) windowspecdefinition(specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#xL, avg(y#x) windowspecdefinition(specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg(y) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#x]
            +- Project [x#x, y#x, (x#x + 1) AS _w1#x, z#x]
               +- Project [1 AS x#x, 2 AS y#x, 3 AS z#x]
                  +- OneRowRelation


-- !query
table t
|> select x, count(*) over ()
|> select x
-- !query analysis
Project [x#x]
+- Project [x#x, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
   +- Project [x#x, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
      +- Window [count(1) windowspecdefinition(specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
         +- Project [x#x]
            +- SubqueryAlias spark_catalog.default.t
               +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select distinct x, y
-- !query analysis
Distinct
+- Project [x#x, y#x]
   +- SubqueryAlias spark_catalog.default.t
      +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select *
-- !query analysis
Project [x#x, y#x]
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select * except (y)
-- !query analysis
Project [x#x]
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select /*+ repartition(3) */ *
-- !query analysis
Repartition 3, true
+- Project [x#x, y#x]
   +- SubqueryAlias spark_catalog.default.t
      +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select /*+ repartition(3) */ distinct x
-- !query analysis
Repartition 3, true
+- Distinct
   +- Project [x#x]
      +- SubqueryAlias spark_catalog.default.t
         +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select /*+ repartition(3) */ all x
-- !query analysis
Repartition 3, true
+- Project [x#x]
   +- SubqueryAlias spark_catalog.default.t
      +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> select sum(x) as result
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "PIPE_OPERATOR_SELECT_CONTAINS_AGGREGATE_FUNCTION",
  "sqlState" : "0A000",
  "messageParameters" : {
    "expr" : "sum(x#x)"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 19,
    "stopIndex" : 24,
    "fragment" : "sum(x)"
  } ]
}


-- !query
table t
|> select y, length(y) + sum(x) as result
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "PIPE_OPERATOR_SELECT_CONTAINS_AGGREGATE_FUNCTION",
  "sqlState" : "0A000",
  "messageParameters" : {
    "expr" : "sum(x#x)"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 34,
    "stopIndex" : 39,
    "fragment" : "sum(x)"
  } ]
}


-- !query
table t
|> where true
-- !query analysis
Filter true
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where x + length(y) < 4
-- !query analysis
Filter ((x#x + length(y#x)) < 4)
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where x + length(y) < 4
|> where x + length(y) < 3
-- !query analysis
Filter ((x#x + length(y#x)) < 3)
+- SubqueryAlias __auto_generated_subquery_name
   +- Filter ((x#x + length(y#x)) < 4)
      +- SubqueryAlias spark_catalog.default.t
         +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
(select x, sum(length(y)) as sum_len from t group by x)
|> where x = 1
-- !query analysis
Filter (x#x = 1)
+- SubqueryAlias __auto_generated_subquery_name
   +- Aggregate [x#x], [x#x, sum(length(y#x)) AS sum_len#xL]
      +- SubqueryAlias spark_catalog.default.t
         +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where t.x = 1
-- !query analysis
Filter (x#x = 1)
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where spark_catalog.default.t.x = 1
-- !query analysis
Filter (x#x = 1)
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
(select col from st)
|> where col.i1 = 1
-- !query analysis
Filter (col#x.i1 = 1)
+- SubqueryAlias __auto_generated_subquery_name
   +- Project [col#x]
      +- SubqueryAlias spark_catalog.default.st
         +- Relation spark_catalog.default.st[x#x,col#x] parquet


-- !query
table st
|> where st.col.i1 = 2
-- !query analysis
Filter (col#x.i1 = 2)
+- SubqueryAlias spark_catalog.default.st
   +- Relation spark_catalog.default.st[x#x,col#x] parquet


-- !query
table t
|> where exists (select a from other where x = a limit 1)
-- !query analysis
Filter exists#x [x#x]
:  +- GlobalLimit 1
:     +- LocalLimit 1
:        +- Project [a#x]
:           +- Filter (outer(x#x) = a#x)
:              +- SubqueryAlias spark_catalog.default.other
:                 +- Relation spark_catalog.default.other[a#x,b#x] json
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where (select any_value(a) from other where x = a limit 1) = 1
-- !query analysis
Filter (scalar-subquery#x [x#x] = 1)
:  +- GlobalLimit 1
:     +- LocalLimit 1
:        +- Aggregate [any_value(a#x, false) AS any_value(a)#x]
:           +- Filter (outer(x#x) = a#x)
:              +- SubqueryAlias spark_catalog.default.other
:                 +- Relation spark_catalog.default.other[a#x,b#x] json
+- SubqueryAlias spark_catalog.default.t
   +- Relation spark_catalog.default.t[x#x,y#x] csv


-- !query
table t
|> where sum(x) = 1
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WHERE_CONDITION",
  "sqlState" : "42903",
  "messageParameters" : {
    "condition" : "\"(sum(x) = 1)\"",
    "expressionList" : "sum(spark_catalog.default.t.x)"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 1,
    "stopIndex" : 27,
    "fragment" : "table t\n|> where sum(x) = 1"
  } ]
}


-- !query
table t
|> where y = 'abc' or length(y) + sum(x) = 1
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WHERE_CONDITION",
  "sqlState" : "42903",
  "messageParameters" : {
    "condition" : "\"((y = abc) OR ((length(y) + sum(x)) = 1))\"",
    "expressionList" : "sum(spark_catalog.default.t.x)"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 1,
    "stopIndex" : 52,
    "fragment" : "table t\n|> where y = 'abc' or length(y) + sum(x) = 1"
  } ]
}


-- !query
table t
|> where first_value(x) over (partition by y) = 1
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "_LEGACY_ERROR_TEMP_1034",
  "messageParameters" : {
    "clauseName" : "WHERE"
  }
}


-- !query
select * from t where first_value(x) over (partition by y) = 1
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "_LEGACY_ERROR_TEMP_1034",
  "messageParameters" : {
    "clauseName" : "WHERE"
  }
}


-- !query
table t
|> select x, length(y) as z
|> where x + length(y) < 4
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`y`",
    "proposal" : "`x`, `z`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 57,
    "stopIndex" : 57,
    "fragment" : "y"
  } ]
}


-- !query
(select x, sum(length(y)) as sum_len from t group by x)
|> where sum(length(y)) = 3
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`y`",
    "proposal" : "`x`, `sum_len`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 77,
    "stopIndex" : 77,
    "fragment" : "y"
  } ]
}


-- !query
table join_test_t1
|> inner join join_test_empty_table
-- !query analysis
Join Inner
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> cross join join_test_empty_table
-- !query analysis
Join Cross
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> left outer join join_test_empty_table
-- !query analysis
Join LeftOuter
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> right outer join join_test_empty_table
-- !query analysis
Join RightOuter
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> full outer join join_test_empty_table using (a)
-- !query analysis
Project [coalesce(a#x, a#x) AS a#x]
+- Join FullOuter, (a#x = a#x)
   :- SubqueryAlias join_test_t1
   :  +- View (`join_test_t1`, [a#x])
   :     +- Project [cast(a#x as int) AS a#x]
   :        +- Project [a#x]
   :           +- SubqueryAlias grouping
   :              +- LocalRelation [a#x]
   +- SubqueryAlias join_test_empty_table
      +- View (`join_test_empty_table`, [a#x])
         +- Project [cast(a#x as int) AS a#x]
            +- Project [a#x]
               +- Filter false
                  +- SubqueryAlias join_test_t2
                     +- View (`join_test_t2`, [a#x])
                        +- Project [cast(a#x as int) AS a#x]
                           +- Project [a#x]
                              +- SubqueryAlias grouping
                                 +- LocalRelation [a#x]


-- !query
table join_test_t1
|> full outer join join_test_empty_table on (join_test_t1.a = join_test_empty_table.a)
-- !query analysis
Join FullOuter, (a#x = a#x)
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> left semi join join_test_empty_table
-- !query analysis
Join LeftSemi
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> left anti join join_test_empty_table
-- !query analysis
Join LeftAnti
:- SubqueryAlias join_test_t1
:  +- View (`join_test_t1`, [a#x])
:     +- Project [cast(a#x as int) AS a#x]
:        +- Project [a#x]
:           +- SubqueryAlias grouping
:              +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
select * from join_test_t1 where true
|> inner join join_test_empty_table
-- !query analysis
Join Inner
:- Project [a#x]
:  +- Filter true
:     +- SubqueryAlias join_test_t1
:        +- View (`join_test_t1`, [a#x])
:           +- Project [cast(a#x as int) AS a#x]
:              +- Project [a#x]
:                 +- SubqueryAlias grouping
:                    +- LocalRelation [a#x]
+- SubqueryAlias join_test_empty_table
   +- View (`join_test_empty_table`, [a#x])
      +- Project [cast(a#x as int) AS a#x]
         +- Project [a#x]
            +- Filter false
               +- SubqueryAlias join_test_t2
                  +- View (`join_test_t2`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
select 1 as x, 2 as y
|> inner join (select 1 as x, 4 as y) using (x)
-- !query analysis
Project [x#x, y#x, y#x]
+- Join Inner, (x#x = x#x)
   :- Project [1 AS x#x, 2 AS y#x]
   :  +- OneRowRelation
   +- SubqueryAlias __auto_generated_subquery_name
      +- Project [1 AS x#x, 4 AS y#x]
         +- OneRowRelation


-- !query
table join_test_t1
|> inner join (join_test_t2 jt2 inner join join_test_t3 jt3 using (a)) using (a)
|> select a, join_test_t1.a, jt2.a, jt3.a
-- !query analysis
Project [a#x, a#x, a#x, a#x]
+- Project [a#x, a#x, a#x]
   +- Join Inner, (a#x = a#x)
      :- SubqueryAlias join_test_t1
      :  +- View (`join_test_t1`, [a#x])
      :     +- Project [cast(a#x as int) AS a#x]
      :        +- Project [a#x]
      :           +- SubqueryAlias grouping
      :              +- LocalRelation [a#x]
      +- Project [a#x, a#x]
         +- Join Inner, (a#x = a#x)
            :- SubqueryAlias jt2
            :  +- SubqueryAlias join_test_t2
            :     +- View (`join_test_t2`, [a#x])
            :        +- Project [cast(a#x as int) AS a#x]
            :           +- Project [a#x]
            :              +- SubqueryAlias grouping
            :                 +- LocalRelation [a#x]
            +- SubqueryAlias jt3
               +- SubqueryAlias join_test_t3
                  +- View (`join_test_t3`, [a#x])
                     +- Project [cast(a#x as int) AS a#x]
                        +- Project [a#x]
                           +- SubqueryAlias grouping
                              +- LocalRelation [a#x]


-- !query
table join_test_t1
|> inner join join_test_t2 tablesample (100 percent) jt2 using (a)
-- !query analysis
Project [a#x]
+- Join Inner, (a#x = a#x)
   :- SubqueryAlias join_test_t1
   :  +- View (`join_test_t1`, [a#x])
   :     +- Project [cast(a#x as int) AS a#x]
   :        +- Project [a#x]
   :           +- SubqueryAlias grouping
   :              +- LocalRelation [a#x]
   +- Sample 0.0, 1.0, false, 750
      +- SubqueryAlias jt2
         +- SubqueryAlias join_test_t2
            +- View (`join_test_t2`, [a#x])
               +- Project [cast(a#x as int) AS a#x]
                  +- Project [a#x]
                     +- SubqueryAlias grouping
                        +- LocalRelation [a#x]


-- !query
table join_test_t1
|> inner join (select 1 as a) tablesample (100 percent) jt2 using (a)
-- !query analysis
Project [a#x]
+- Join Inner, (a#x = a#x)
   :- SubqueryAlias join_test_t1
   :  +- View (`join_test_t1`, [a#x])
   :     +- Project [cast(a#x as int) AS a#x]
   :        +- Project [a#x]
   :           +- SubqueryAlias grouping
   :              +- LocalRelation [a#x]
   +- SubqueryAlias jt2
      +- Sample 0.0, 1.0, false, 77
         +- Project [1 AS a#x]
            +- OneRowRelation


-- !query
table join_test_t1
|> join join_test_t1 using (a)
-- !query analysis
Project [a#x]
+- Join Inner, (a#x = a#x)
   :- SubqueryAlias join_test_t1
   :  +- View (`join_test_t1`, [a#x])
   :     +- Project [cast(a#x as int) AS a#x]
   :        +- Project [a#x]
   :           +- SubqueryAlias grouping
   :              +- LocalRelation [a#x]
   +- SubqueryAlias join_test_t1
      +- View (`join_test_t1`, [a#x])
         +- Project [cast(a#x as int) AS a#x]
            +- Project [a#x]
               +- SubqueryAlias grouping
                  +- LocalRelation [a#x]


-- !query
table lateral_test_t1
|> join lateral (select c1)
-- !query analysis
LateralJoin lateral-subquery#x [c1#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [outer(c1#x) AS c1#x]
:        +- OneRowRelation
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select c1 from lateral_test_t2)
-- !query analysis
LateralJoin lateral-subquery#x [], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [c1#x]
:        +- SubqueryAlias lateral_test_t2
:           +- View (`lateral_test_t2`, [c1#x, c2#x])
:              +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                 +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select lateral_test_t1.c1 from lateral_test_t2)
-- !query analysis
LateralJoin lateral-subquery#x [c1#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [outer(c1#x) AS c1#x]
:        +- SubqueryAlias lateral_test_t2
:           +- View (`lateral_test_t2`, [c1#x, c2#x])
:              +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                 +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select lateral_test_t1.c1 + t2.c1 from lateral_test_t2 t2)
-- !query analysis
LateralJoin lateral-subquery#x [c1#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [(outer(c1#x) + c1#x) AS (outer(lateral_test_t1.c1) + c1)#x]
:        +- SubqueryAlias t2
:           +- SubqueryAlias lateral_test_t2
:              +- View (`lateral_test_t2`, [c1#x, c2#x])
:                 +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                    +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select *)
-- !query analysis
LateralJoin lateral-subquery#x [], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project
:        +- OneRowRelation
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select * from lateral_test_t2)
-- !query analysis
LateralJoin lateral-subquery#x [], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [c1#x, c2#x]
:        +- SubqueryAlias lateral_test_t2
:           +- View (`lateral_test_t2`, [c1#x, c2#x])
:              +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                 +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select lateral_test_t1.* from lateral_test_t2)
-- !query analysis
LateralJoin lateral-subquery#x [c1#x && c2#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [outer(c1#x) AS c1#x, outer(c2#x) AS c2#x]
:        +- SubqueryAlias lateral_test_t2
:           +- View (`lateral_test_t2`, [c1#x, c2#x])
:              +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                 +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral (select lateral_test_t1.*, t2.* from lateral_test_t2 t2)
-- !query analysis
LateralJoin lateral-subquery#x [c1#x && c2#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [outer(c1#x) AS c1#x, outer(c2#x) AS c2#x, c1#x, c2#x]
:        +- SubqueryAlias t2
:           +- SubqueryAlias lateral_test_t2
:              +- View (`lateral_test_t2`, [c1#x, c2#x])
:                 +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
:                    +- LocalRelation [col1#x, col2#x]
+- SubqueryAlias lateral_test_t1
   +- View (`lateral_test_t1`, [c1#x, c2#x])
      +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
table lateral_test_t1
|> join lateral_test_t2
|> join lateral (select lateral_test_t1.c2 + lateral_test_t2.c2)
-- !query analysis
LateralJoin lateral-subquery#x [c2#x && c2#x], Inner
:  +- SubqueryAlias __auto_generated_subquery_name
:     +- Project [(outer(c2#x) + outer(c2#x)) AS (outer(lateral_test_t1.c2) + outer(lateral_test_t2.c2))#x]
:        +- OneRowRelation
+- Join Inner
   :- SubqueryAlias lateral_test_t1
   :  +- View (`lateral_test_t1`, [c1#x, c2#x])
   :     +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
   :        +- LocalRelation [col1#x, col2#x]
   +- SubqueryAlias lateral_test_t2
      +- View (`lateral_test_t2`, [c1#x, c2#x])
         +- Project [cast(col1#x as int) AS c1#x, cast(col2#x as int) AS c2#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
table natural_join_test_t1
|> natural join natural_join_test_t2
|> where k = "one"
-- !query analysis
Filter (k#x = one)
+- SubqueryAlias __auto_generated_subquery_name
   +- Project [k#x, v1#x, v2#x]
      +- Join Inner, (k#x = k#x)
         :- SubqueryAlias natural_join_test_t1
         :  +- View (`natural_join_test_t1`, [k#x, v1#x])
         :     +- Project [cast(k#x as string) AS k#x, cast(v1#x as int) AS v1#x]
         :        +- Project [k#x, v1#x]
         :           +- SubqueryAlias natural_join_test_t1
         :              +- LocalRelation [k#x, v1#x]
         +- SubqueryAlias natural_join_test_t2
            +- View (`natural_join_test_t2`, [k#x, v2#x])
               +- Project [cast(k#x as string) AS k#x, cast(v2#x as int) AS v2#x]
                  +- Project [k#x, v2#x]
                     +- SubqueryAlias natural_join_test_t2
                        +- LocalRelation [k#x, v2#x]


-- !query
table natural_join_test_t1
|> natural join natural_join_test_t2 nt2
|> select natural_join_test_t1.*
-- !query analysis
Project [k#x, v1#x]
+- Project [k#x, v1#x, v2#x]
   +- Join Inner, (k#x = k#x)
      :- SubqueryAlias natural_join_test_t1
      :  +- View (`natural_join_test_t1`, [k#x, v1#x])
      :     +- Project [cast(k#x as string) AS k#x, cast(v1#x as int) AS v1#x]
      :        +- Project [k#x, v1#x]
      :           +- SubqueryAlias natural_join_test_t1
      :              +- LocalRelation [k#x, v1#x]
      +- SubqueryAlias nt2
         +- SubqueryAlias natural_join_test_t2
            +- View (`natural_join_test_t2`, [k#x, v2#x])
               +- Project [cast(k#x as string) AS k#x, cast(v2#x as int) AS v2#x]
                  +- Project [k#x, v2#x]
                     +- SubqueryAlias natural_join_test_t2
                        +- LocalRelation [k#x, v2#x]


-- !query
table natural_join_test_t1
|> natural join natural_join_test_t2 nt2
|> natural join natural_join_test_t3 nt3
|> select natural_join_test_t1.*, nt2.*, nt3.*
-- !query analysis
Project [k#x, v1#x, k#x, v2#x, k#x, v3#x]
+- Project [k#x, v1#x, v2#x, v3#x, k#x, k#x]
   +- Join Inner, (k#x = k#x)
      :- Project [k#x, v1#x, v2#x, k#x]
      :  +- Join Inner, (k#x = k#x)
      :     :- SubqueryAlias natural_join_test_t1
      :     :  +- View (`natural_join_test_t1`, [k#x, v1#x])
      :     :     +- Project [cast(k#x as string) AS k#x, cast(v1#x as int) AS v1#x]
      :     :        +- Project [k#x, v1#x]
      :     :           +- SubqueryAlias natural_join_test_t1
      :     :              +- LocalRelation [k#x, v1#x]
      :     +- SubqueryAlias nt2
      :        +- SubqueryAlias natural_join_test_t2
      :           +- View (`natural_join_test_t2`, [k#x, v2#x])
      :              +- Project [cast(k#x as string) AS k#x, cast(v2#x as int) AS v2#x]
      :                 +- Project [k#x, v2#x]
      :                    +- SubqueryAlias natural_join_test_t2
      :                       +- LocalRelation [k#x, v2#x]
      +- SubqueryAlias nt3
         +- SubqueryAlias natural_join_test_t3
            +- View (`natural_join_test_t3`, [k#x, v3#x])
               +- Project [cast(k#x as string) AS k#x, cast(v3#x as int) AS v3#x]
                  +- Project [k#x, v3#x]
                     +- SubqueryAlias natural_join_test_t3
                        +- LocalRelation [k#x, v3#x]


-- !query
table join_test_t1
|> inner join join_test_empty_table
   inner join join_test_empty_table
-- !query analysis
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "PARSE_SYNTAX_ERROR",
  "sqlState" : "42601",
  "messageParameters" : {
    "error" : "'inner'",
    "hint" : ""
  }
}


-- !query
table join_test_t1
|> select 1 + 2 as result
|> full outer join join_test_empty_table on (join_test_t1.a = join_test_empty_table.a)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`join_test_t1`.`a`",
    "proposal" : "`result`, `join_test_empty_table`.`a`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 91,
    "stopIndex" : 104,
    "fragment" : "join_test_t1.a"
  } ]
}


-- !query
table join_test_t1 jt
|> cross join (select * from jt)
-- !query analysis
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "PARSE_SYNTAX_ERROR",
  "sqlState" : "42601",
  "messageParameters" : {
    "error" : "'jt'",
    "hint" : ""
  }
}


-- !query
drop table t
-- !query analysis
DropTable false, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.t


-- !query
drop table other
-- !query analysis
DropTable false, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.other


-- !query
drop table st
-- !query analysis
DropTable false, false
+- ResolvedIdentifier V2SessionCatalog(spark_catalog), default.st
